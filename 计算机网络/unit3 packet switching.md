## what is packet switching
### circuit switching
分组交换的前身是电路交换，用于早期的电话系统，可以通过三步解析它，首先是拨号，这告诉了交换机我们想要连接的端点，从而建立专用的电路，然后是使用，在我们说话的过程中，声信号被转换成电信号通过交换机建立的电路传递，最后是挂断，要移除该专用电路和路径上交换机的任意状态![输入图片说明](/imgs/2025-08-15/bjHCJUR65UbWrACX.png)

示意图

![输入图片说明](/imgs/2025-08-15/6C6cE8LGdb6Mf3ij.png)电路交换的性质

电路交换在电话系统中运行的很好，但是用于计算机通信时会有一些问题：
1. 效率不高，计算机通信中常见猝发通信，并且可能在建立连接后进入长时间的沉默，如浏览网页时，电路交换在专用电路建立时是独占的，不允许在结束断开连接时被别的通信使用该线路，因此易造成效率低下
2. 多样化的速率，计算机通信中不同应用不同时间的传输速率一般是不同的，电路交换的单一线路提供的速率不符合实际使用情况
3. 状态维护，在电路交换中，我们需要维护所有的状态，如果出现故障，我们需要进入并更改这些状态，来重新路由电话
### packet switching
分组交换网络由端主机、链路和分组交换机组成，路由器也是分组交换机的一种，它处理互联网地址![输入图片说明](/imgs/2025-08-15/mJ4gWgnQSEnA2F66.png)分组交换示意图

分组交换机有缓冲区（buffer），假设有两个数据包以输出链路的全速率同时到达一个分组交换机时，数据包交换机必须保留其中一个，一次只能发送一个，因一个交换机可能有多个输入链路，因此要有一个缓冲区来保存多个数据包
![输入图片说明](/imgs/2025-08-17/oIDhbixS2vnV8tr1.png)
分组交换的性质

### why use it
![输入图片说明](/imgs/2025-08-18/ZP8H1ACvwOhl9sdD.png)使用分组交换的原因

第三个重要原因是，互联网最初被设计成已有网络的互连，当时所有的通信网络/计算机网络都是分组交换的，互联网要连接这些网络就也要使用分组交换

![输入图片说明](/imgs/2025-08-21/MIxlXESMa6CeEBWx.png)分组交换与电路交换的区别

![输入图片说明](/imgs/2025-08-21/YzhCvDTpst9xigU5.png)分组交换的特点

## 传播延迟、分组延迟与排队延迟
### useful definition
![输入图片说明](/imgs/2025-08-18/5ECYxlTHARUFFHjq.png)传播延迟的定义
和链路大小无关，只和链路长度和传播速度（一般是光速）有关

![输入图片说明](/imgs/2025-08-19/eTc1S2qTnYxMG0rD.png)
分组延迟的定义
是从分组的第一个bit被放到链路上开始，到最后一个bit被放到链路上所用的时间，本质上取决于我们可以打包（packet）的有多紧
### end-to-end delay
端到端延迟是从在第一个链路上发送的第一个bit开始，直到数据包最后一个bit到达目的地所用的时间，是分组延迟和传播延迟的和
![输入图片说明](/imgs/2025-08-19/c5a7bk72okhgAU3f.png)端到端延迟
![输入图片说明](/imgs/2025-08-19/MPpCiS46oHxtvSFq.png)example

链路在所用用户的数据包之间是共享的，多个数据包在交换机处可能需要在缓冲区等待，称有大量数据包在队列等待通过的行为的下一条链路为拥塞
在缓冲区存在的情况下，端到端的延迟还需要多考虑在各个交换机的等待时间，即排队延迟
![输入图片说明](/imgs/2025-08-19/9vgMw51pV4ICtCZs.png)考虑排队延迟后的公式

### queuing delay
一些应用，如视频播放器/网站、语音通话、音乐软件等，会更看重数据的实时性，因此其对于排队延迟更敏感，为解决排队延迟带来的问题，一般会采用数据缓冲区，以防一些数据包延迟或没有及时到达，出现短暂的故障，设计缓冲区时一般要考虑提前多长时间
![输入图片说明](/imgs/2025-08-20/OPoY2SFJlcqbmg3i.png)示意图

![输入图片说明](/imgs/2025-08-20/5evYBZY1WEE23iFI.png)上图是发送、接收、播放与缓冲的字节的关系图，其中，纵坐标是累积的字节数，横坐标是时间，曲线间水平方向的差分别表示了变化的延迟时长（因为排队延迟）和缓冲所用的时间，竖直方向上的差分别表示了缓冲路径上缓冲的数据量有多大和（客户端）缓冲区的字节数，接收的字节的曲线的斜率体现了最后一个链路的速率（上限）

![输入图片说明](/imgs/2025-08-21/fplG2uQufPLhV8iS.png)客户端视角

![输入图片说明](/imgs/2025-08-21/wL6D9KIiCK5MimfO.png)缓冲区不够的情况
一般客户端会通过冻结屏幕等待缓冲来解决

![输入图片说明](/imgs/2025-08-21/3QPXRramZMBKMHfj.png)playback buffer summary

![输入图片说明](/imgs/2025-08-21/aSUVzJrgAPmAT5Qo.png)end-to-end delay summary

## queue models
### simple deterministic queue model
![输入图片说明](/imgs/2025-08-21/LghPru4OW7BsRy2A.png)示意图

Q是排队中的字节数，A是累积到达的字节数，D是输出离开的字节数，均为t的函数，R是输出链路的速率
![输入图片说明](/imgs/2025-08-21/wbexRll5THJIBDN6.png)坐标下的示意图
绿色曲线为A，黄色是D，标注的红色即为Q，是绿色和黄色线的竖直距离，水平差表示了一个字节经过了多久才离开路由器，用d表示其延迟时长

![输入图片说明](/imgs/2025-08-21/FA5Yh0VqjnMIwva2.png)计算题例题，计算平均队列占用率

### small packets reduce end to end delay
![输入图片说明](/imgs/2025-08-21/7mli5TVMNRLTyW5Z.png)用更小的数据包的原因
有点类似于计算机组成原理中的流水线，分成更小的包发送可以极大的提高发送效率

### statistical multiplexing
![输入图片说明](/imgs/2025-08-21/JH61GFGrvoDBd8VR.png)统计多路复用
用于处理多输入单输出时，输出链路跟不上输入速率的问题

![输入图片说明](/imgs/2025-08-21/RAJYhNlFJuDJCyIt.png)example for statistical multiplex
AB两个流量相加预期会得到统计复用增益

![输入图片说明](/imgs/2025-08-21/JMEUxaGVM7GLThIb.png)统计复用增益的计算
两种不同的情况，一种是未使用缓冲区，一种使用了缓冲区，使用了缓冲区的情况下值会更大，总之，统计复用可以让我们在一个链路上高效的承载多个流，这也是我们使用分组交换的主要原因之一

![输入图片说明](/imgs/2025-08-26/UgUSM5Fm7YhpEtvm.png)为什么要使用统计多路复用，以及其为什么能带来增益，和飞机超出座位数售票同理

### workd example
![输入图片说明](/imgs/2025-08-21/6Y7P9I9cDxueVUrX.png)questionA

![输入图片说明](/imgs/2025-08-21/EUTrqMbAG5d0P33Y.png)questionB，计算了平均每个bit的延迟

![输入图片说明](/imgs/2025-08-22/0DMWEPwqPbAPAoVg.png)questionC，如果随机到达的情况下，保持平均每秒一个100bit的包到达，问占有率如何变化，答案是变大，下图两个例子解释了QC的答案

![输入图片说明](/imgs/2025-08-22/GakiJmB6FrFO1ZFo.png)因为输出速率不变，在case2中会导致需要两倍的时间去输出存储的bit

![输入图片说明](/imgs/2025-08-22/AgrL6d6V3bukTrGN.png)questionD，问再套娃一个队列的情况下，第二个队列的占用率，答案是零，因为不缓存数据

## useful queue properties
![输入图片说明](/imgs/2025-08-22/9MQ7WqOqrn0UT0p1.png)一般来说，数据到达某一个队列的过程是复杂的，因此我们一般将其看作随机过程看待

### burstiness increases delay
![输入图片说明](/imgs/2025-08-22/LFZ5PfavgV6fwozz.png)example
上图中猝发传输导致了队列的平均占有率更高，同时也导致了方差更大，导致了延迟增加

### determinism minimizes delay
通常，确定的系统会减小延迟，反之，随机到达的情况会有更高的平均延迟

### little's result
![输入图片说明](/imgs/2025-08-23/3W3KqUHBBlL3HdxH.png)一个有用的小结论，图中λ表示一个明确的到达速率，L是队列中的平均bit数，d是平均延迟，三者关系如上图所示，此公式不考虑无丢包（丢弃）情况的系统，L与d要对应，如果L是队列中正在被服务的数据的平均数量，则d是直到用户完成服务的平均延迟；如果L是仅在队列中但尚未进入服务的数据的平均数量，则d是通过队列进入服务之前的平均延迟

### M/M/1 queue
![输入图片说明](/imgs/2025-08-24/U46y1hVpBZIYsAzR.png)泊松过程

![输入图片说明](/imgs/2025-08-24/SUEyEX0UAsWaoXyO.png)为什么我们使用泊松过程

需要注意的几点：
1. 网络通信具有很大的猝发性
2. 数据包的到达不是泊松过程
3. 但是泊松过程很适用于描述新数据流的到达

M/M/1 queue是使用泊松过程的一个常见例子，第一个M指的是马尔可夫到达过程，本例中是泊松过程，第二个M指的是马尔可夫服务过程，本例中是呈指数分布的，这意味着为一个数据包服务，且每个数据包的服务时间与其他的独立，1意味着只有一条输出线为该队列服务
M/M/1 queue假设缓冲区无限大，请求来源无限和工作守恒，即只要有请求就会不停工作

![输入图片说明](/imgs/2025-08-25/PW0Fc8rFgkYAZbt6.png)M/M/1 queue的公式，d代表一个数据包通过该队列的平均延迟，L来表示平均占有率，λ/μ表示交通强度，右图几乎适用于任意排队系统，我们用mm1 queue来代替更复杂系统的原因仅仅是其数学模型更简单，表达式也更简单

## how a packet switch works
### what a packet switch look like
![输入图片说明](/imgs/2025-08-25/NZyYs68QFQAnn7pb.png)多路输入输出数据包交换机示意图，当一个数据包到达时，路由器会根据其报头信息来查找下一跳转发地址，然后通过数据总线（中间黑线）转发到背板，到对应的输出链路去，当链路需求冲突时（如图中的两个红色数据包），将把一个数据包一直发送到它的输出，另一个数据包留在缓冲区

![输入图片说明](/imgs/2025-08-25/w7dFm0kS4NQGaomV.png)更具体的，一种常见类型的数据包交换机是以太网交换机，上图说明了以太网交换机的四种基本操作

![输入图片说明](/imgs/2025-08-25/pwjTh33eFxWYUqOr.png)上图说明了互联网路由器的七种基本操作

交换机的主要功能和关注的操作：查找地址与转发

![输入图片说明](/imgs/2025-08-25/sIQQ5YXxEocgyWiM.png)以太网交换机的地址查找，通过查找表实现

![输入图片说明](/imgs/2025-08-25/73JDDhI4kNUyweWv.png)ip地址的查找表，匹配时通过匹配最长前缀实现，ip转发表匹配完后，会解析对应ip地址的以太网地址，将数据包封装到对应的以太网帧中

![输入图片说明](/imgs/2025-08-25/mbTncjuC01WgjzT1.png)最长前缀匹配

![输入图片说明](/imgs/2025-08-25/Ha2lTDWg2IrlXPNQ.png)匹配的查找的常见方法，通过二叉树实现

![输入图片说明](/imgs/2025-08-25/o82212xxqHdwQecj.png)另一种存储查找方法，三态内容可寻址存储器（TCAM），是并行查找匹配的，消耗较大但是速度快，通常在路由器中使用

![输入图片说明](/imgs/2025-08-26/sSt9tDe2B96n2P3D.png)交换机查找地址的范式

### 交换机的队列
通常可以分为输出队列交换机（即前面所展示的图片），输入队列交换机和虚拟输出队列

![输入图片说明](/imgs/2025-08-26/plq7jgEYJYo972N6.png)输入队列交换机，将缓冲区放到了输入端口处，使得每个缓冲区的传输速率要求从（N+1）*R变为了目标的2R，本质原因是避免了多个输入同输出链路的数据包在输出队列的缓冲区拥塞，但是在输入队列交换机中存在首部阻塞问题

![输入图片说明](/imgs/2025-08-26/Ou6KPSP75eW827hK.png)首部阻塞示意图，图中黑色与绿色的链路是空闲的，但是因为被红色的数据包在前面阻塞了，导致了资源的浪费与等待带来的延迟，解决的方案是虚拟输出队列

![输入图片说明](/imgs/2025-08-26/WcQQ4ZnTgl8dVqjp.png)虚拟输出队列示意图，为了解决首部阻塞，本质上就是在每一个输入端口为每一个输出端口都维护一个独立的队列，在把队列传输速率（内存运行速率）降低到2R的前提下，最大的提高了吞吐量

![输入图片说明](/imgs/2025-08-26/YJboJPRBrG56Xl77.png)OQ的负载函数-延迟图
输出队列交换机的性质：
1. 当系统中有数据包等待发送到某个输出链路时，该链路永远不会空闲，称为工作保留的
2. 吞吐量最大化
3. 预期延迟最小化

![输入图片说明](/imgs/2025-08-26/v8TOJpH658bYqadw.png)IQ/VOQ的负载函数-延迟示意图
首部负载会导致几乎一半的性能损失，但可以通过虚拟输出队列来优化，使用voq时延迟略高，但是asm吞吐量100%

## strict properties and guaranteed flow rates
fifo队列的情况下，较大的流更容易挤占队列，导致更小的流丢包，总而言之，fifo不能区分重要性，对于缓冲区大小为B，输出速率为R的队列而言，最后一个数据包的最大延迟为B/R

![输入图片说明](/imgs/2025-08-26/9xsSvvFqh7LswObi.png)严格优先级队列的示意图，在高优先级数据流量合理较小时适用，否则低优先级的流量会有阻塞死的风险

![输入图片说明](/imgs/2025-08-26/wmsBhumJAsKsRbX1.png)权重优先级队列的示意图，可以将各个队列的速率看作是对应权重的占比乘上链路的实际输出速率，更像是速率的分配，例如只有两个队列时，一个权重2，一个1，则对应一个队列输出两次后另一个队列输出一次。当所有数据包长度相同时，我们依次访问队列一次，称为一轮，然后将分别发送wi个单位，故他们可以是每个队列一轮中的位或完整数据包

实际dui'l
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTQ3NDQxMTg2OCwxMzkwNDU1NzA2LDIwMj
A1NTI5MjEsMTM0MzY5ODkxMywxODM0NzgwMjQzLDExMzk1MDUy
OTgsLTEwMDY0Njk4MTQsMTg0NzM5OTI2MCwtMTY4NzAyNjQ2Ni
wtMTMwODYxNjQxNCwxNjA0NTIwNTg4LDE0NjQ3MTQ1MTEsLTEz
NjI2OTA2ODMsLTk1MTIzNDQwNCw1MDA0OTgwMDMsLTQ0NTkzNz
I4MywxNTczMTMwMTIxLDExNDc2MDE2OTUsMTkxMzY4NDk0MSw0
MjgyNDIwMTldfQ==
-->